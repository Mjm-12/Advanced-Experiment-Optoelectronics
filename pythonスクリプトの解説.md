# スクリプトの使い方と動作解説

ChatGPTを用いて作成しました。仕様モデルはo3-mini-highです。

## できること

- **波形のプロット**  
  - **生の実測データ（originalモード）**：取得した波形データをそのままプロット  
  - **平均化波形（averagedモード）**：基本周波数に基づき各周期を抽出し、平均化した波形をプロット

- **FFT解析**  
  - 実測波形の周波数成分を解析し、FFTグラフに表示します。  
  - 基本周波数の検出、高調波成分の評価、THD（全高調波歪み）などの計算を行います。  
  - 必要に応じてFFT結果をCSVファイルへエクスポートすることも可能です。

## 1. 使い方

### 1.1 CSVファイルの準備
- **ファイル形式**：  
  - Keysightのオシロスコープから出力されたCSVデータを利用するための最適化されています。そのため、CSVファイルの最初の2行はヘッダーとしてスキップされます。  
  - **注意**:CSVを保存する際にFFT結果も併せて保存されていると読み込みエラーとなります。その場合、FFT結果は取り除いてください。

### 1.2 スクリプトの実行
- **実行環境**：  
  - ローカルのPython環境で実行可能です（Google Colabで利用可能なバージョンも用意しています）。
- **手順**：  
  1. スクリプトを実行すると、**Tkinter** のファイル選択ダイアログが表示されます。  
  2. 対象のCSVファイルを選択してください。  
  3. ファイルを読み込んだ後、スクリプトが自動的に波形のプロットとFFT解析を行い、グラフを表示します。  
  4. コンソールには、波形統計情報（最大値、最小値、ピーク・トゥー・ピーク、DC成分）やFFT解析結果（基本周波数、高調波比、ノイズフロア、THDなど）が出力されます。

### 1.3 ユーザ設定パラメータの変更
- スクリプト冒頭の「User-configurable parameters」部分で、以下のような設定を変更できます。
  - **波形描画モード**：`WAVEFORM_PLOT_MODE`  
    - `"original"`：生の実測データをプロット  
    - `"averaged"`：基本周波数に基づき平均化した波形をプロット
        - `num_cycles_user`:平均化するデータの周期数
  - **グラフの軸設定**：  
    - 波形グラフやFFTグラフのx軸、y軸の表示範囲を `"manual"` または `"auto"` で選択  
    - manualモードの場合`MANUAL_WAVEFORM_XLIM`, `MANUAL_FFT_XLIM`, `MANUAL_FFT_YLIM` で手動設定可能
  - **FFT解析に関する設定**：  
    - [窓関数](https://w.wiki/D869)の種類（例：`"hann"`, `"hamming"`, `"rectangular"`など）  
    - 高調波の最大表示次数（`MAX_HARMONIC_ORDER`）  
    - FFT結果のCSV出力（`Export_FFT_Result`）
    - FFT解析前に適用されるフィルタの設定(`min_freq_temp`,`max_freq_temp`)

---

## 2. スクリプトの動作内容

### 2.1 インポートされるモジュール
- **numpy**：数値計算、FFT解析に使用  
- **matplotlib**：波形およびFFT結果のグラフ表示  
- **tkinter**：ファイル選択ダイアログの表示  
- **math, os, csv**：補助的な計算、ファイル操作、CSV出力に利用

### 2.2 ユーザ設定パラメータ
- スクリプト冒頭に、ユーザが環境に合わせて変更できるパラメータが列挙されています。  
  例：波形表示モード、グラフ軸の自動/手動設定、FFTの窓関数の選択、フィルタ設定（ハイパス・ローパスの周波数）など。

### 2.3 ヘルパー関数群
- **format_frequency(freq)**  
  周波数の値を、1000 Hz未満なら「xxx.xx Hz」、1000 Hz以上なら「x.xxxx kHz」の形式で文字列に変換します。

- **fft_tick_formatter(x, pos)**  
  FFTグラフのx軸の目盛りを、数値または"k"表示に整形します（例：100, 500, 1k, 5kなど）。

- **generate_fft_ticks(lower, upper)**  
  指定範囲内で、1×10^n や 5×10^n の値を目盛りとしてリスト化します。最小値と最大値も必ず含みます。

- **ordinal(n)**  
  整数に対して英語の序数接尾辞（st, nd, rd, th）を返します。高調波の表示などに使用。

### 2.4 WaveformPlotterクラス
このクラスは、読み込んだ波形データを使って、以下の処理を行います。

- **コンストラクタ (`__init__`)**  
  CSVから読み込んだデータ（電圧、時間）、サンプリング周波数、ファイル名、ファイルパスなどを受け取り、内部変数として保持します。

- **plot(mode='original')**  
  2行のグラフウィンドウを作成し、上段に波形、下段にFFT解析結果を描画します。  
  引数 `mode` により、"original"（生データ）または "averaged"（平均化波形）のどちらかの波形をプロットします。

- **_print_waveform_statistics(data)**  
  波形データの統計量（最大値、最小値、ピーク・トゥー・ピーク値、DC成分）を計算し、コンソールに出力します。

- **_get_fundamental_frequency(data, rate)**  
  FFTを実行して、指定したフィルタ範囲内で最も大きな振幅を持つ周波数を基本周波数として検出します。

- **_plot_waveform(ax)**  
  生の波形データをプロットします。  
  - グラフの軸（x軸）の表示範囲は、ユーザ設定（manualかautoか）に従って決定。  
  - FFT解析から得られた基本周波数を用いて、x軸の表示範囲を自動的に設定する場合もあります。

- **_plot_averaged_waveform(ax)**  
  基本周波数を基に、波形を複数周期に分割し、各周期の波形を平均化して1周期分の平均波形を生成。  
  - 平均化した波形を10周期分連結して表示します。  
  - サンプルデータの位相合わせ（DC値付近の零交差点検出）も行っています。

- **_plot_fft(ax)**  
  FFT解析を実行し、FFT結果を対数スケール（dB表示）でグラフにプロットします。  
  - 選択した窓関数を適用してFFT解析を行い、FFT分解能やナイキスト周波数の制約を考慮します。  
  - 基本周波数および各高調波の振幅、ノイズフロア、THD（全高調波歪み）の計算と出力を実施。  
  - 必要に応じて、FFT解析結果をCSVファイルへエクスポートする機能も備えています。  
  - FFTグラフのx軸は対数スケールで、目盛りの生成やフォーマットも自動調整されます。

### 2.5 main関数
- **main()**  
  1. Tkinterを使ってファイル選択ダイアログを表示し、ユーザがCSVファイルを選択します。  
  2. 選択したCSVファイルから、時間（秒）と電圧のデータを読み込み、サンプリング周波数を計算します。  
  3. 時間軸の単位をミリ秒に変換し、WaveformPlotterクラスのインスタンスを生成します。  
  4. ユーザ設定に基づいた波形描画モードで、グラフ（波形およびFFT解析結果）を描画します。

---

## 3. まとめ

本スクリプトは、実験で取得した波形データをもとに、時間領域および周波数領域の解析を行うためのツールです。  
- **時間領域**：生の波形や平均化した波形をプロットし、統計情報を出力  
- **周波数領域**：FFT解析により基本周波数、高調波、ノイズフロア、THDを評価し、グラフ表示およびCSV出力が可能

理工学系の実験データ解析に役立つこのスクリプトを、ユーザ設定パラメータを必要に応じて調整しながら活用してください。質問や不明点があれば、担当教員や先輩に相談するなどして、実験データの正確な解析につなげましょう。